# 易对接管理员后台系统完整说明（数据库版本）

## 项目概述

这是一个为易对接项目设计的**管理员后台管理系统**，使用 **MySQL 数据库**存储管理员账号密码，同时直接从文件系统（`/userss/` 目录）中读取和管理用户数据。

系统提供了完整的用户管理、会员管理、余额操作、公告管理、账号密码修改等功能。

## 核心特性

✅ **数据库认证** - 管理员账号密码存储在数据库中  
✅ **文件系统用户管理** - 从 `/userss/` 目录读取用户数据  
✅ **用户列表展示** - 查看所有用户信息  
✅ **会员管理** - 增加会员时长、查看会员到期状态  
✅ **余额操作** - 增加用户余额、查看平台总余额  
✅ **用户封禁** - 对用户进行封禁和解封操作  
✅ **用户删除** - 永久删除用户及其所有数据  
✅ **公告管理** - 修改平台公告  
✅ **账号管理** - 修改管理员密码  
✅ **数据统计** - 实时统计用户数、会员数、文档数、总余额等

## 部署步骤

### 步骤 1：初始化数据库

1. 在 MySQL 中执行 `init_admin.sql` 文件来创建管理员表：
   ```bash
   mysql -u ydjht -p ydjht appdoc < init_admin.sql
   ```
   
   或者在 phpMyAdmin 中复制 SQL 内容执行。

2. 默认管理员账号和密码：
   - **账号：** `admin`
   - **密码：** `123456`

### 步骤 2：配置数据库连接

编辑 `admin_config.php` 文件，修改数据库连接信息：

```php
define('DB_HOST', 'localhost');      // 数据库主机
define('DB_USER', 'ydjht');          // 数据库用户名
define('DB_PASS', 'ydjht');          // 数据库密码
define('DB_NAME', 'appdoc');         // 数据库名称
```

### 步骤 3：上传文件

将以下文件上传到您的易对接项目根目录：

| 文件名 | 说明 |
| :--- | :--- |
| `admin_config.php` | 数据库连接和认证配置 |
| `admin_login.php` | 登录页面 |
| `admin_dashboard.php` | 仪表板主页 |
| `admin_user_list.php` | 用户管理页面 |
| `admin_user_action.php` | 用户操作逻辑 |
| `admin_settings.php` | 账号设置页面 |
| `admin_logout.php` | 退出登录 |

### 步骤 4：访问后台

在浏览器中访问：
```
http://您的域名/admin_login.php
```

使用默认账号 `admin` 和密码 `123456` 登录。

## 功能详解

### 1. 登录页面（admin_login.php）

**访问地址：** `admin_login.php`

**功能：**
- 管理员登录
- 从数据库验证账号密码
- 创建 Session 会话

**默认账号：**
- 账号：`admin`
- 密码：`123456`

### 2. 仪表板主页（admin_dashboard.php）

**访问地址：** `admin_dashboard.php`

**功能：**
- 显示平台数据统计：
  - 总用户数
  - 活跃会员数（会员未过期的用户）
  - 会员到期用户数（会员已过期的用户）
  - 平台总余额（所有用户余额之和）
  - 总文档数量
- 修改平台公告（保存在 `userss/{admin}/admin/set/announcement`）

### 3. 用户管理（admin_user_list.php）

**访问地址：** `admin_user_list.php`

**功能：**
- 显示所有用户的详细信息：
  - 账号
  - 昵称
  - 等级
  - 余额
  - 文档数
  - 注册时间
  - 会员到期时间
  - 封禁状态

**用户操作：**

| 操作 | 描述 | 参数 |
| :--- | :--- | :--- |
| **封禁** | 对用户进行封禁，设置解封时间 | 封禁时长（秒），默认 86400（1天） |
| **解封** | 取消用户的封禁状态 | 无 |
| **加余额** | 为用户增加余额 | 增加金额，默认 10 |
| **加会员** | 为用户增加会员时长 | 增加时长（秒），默认 2592000（30天） |
| **删除用户** | 永久删除用户及其所有数据 | 无（不可逆） |

### 4. 账号设置（admin_settings.php）

**访问地址：** `admin_settings.php`

**功能：**
- 修改管理员密码
- 密码存储在数据库 `admin_users` 表中，使用 bcrypt 加密

## 数据库结构

### admin_users 表

| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| `id` | INT | 主键，自增 |
| `username` | VARCHAR(50) | 管理员账号（唯一） |
| `password` | VARCHAR(255) | 密码（bcrypt 加密） |
| `created_at` | TIMESTAMP | 创建时间 |
| `updated_at` | TIMESTAMP | 更新时间 |

### 用户文件系统结构

```
userss/
├── {admin_account}/
│   ├── admin/
│   │   ├── passprotect556          # 管理员密码（文件系统版本，已弃用）
│   │   ├── set/
│   │   │   └── announcement        # 公告
│   │   └── data/
│   └── userss/
│       ├── {user1}/
│       │   ├── name                # 用户昵称
│       │   ├── grade               # 用户等级
│       │   ├── money               # 用户余额
│       │   ├── viptime             # 会员到期时间戳
│       │   ├── seal                # 封禁到期时间戳
│       │   ├── registertime        # 注册时间戳
│       │   ├── file_count          # 文档数量
│       │   └── ...
│       ├── {user2}/
│       └── ...
```

## 关键文件路径

| 数据项 | 文件路径 | 说明 |
| :--- | :--- | :--- |
| 用户昵称 | `userss/{admin}/userss/{user}/name` | 文本文件 |
| 用户等级 | `userss/{admin}/userss/{user}/grade` | 文本文件 |
| 用户余额 | `userss/{admin}/userss/{user}/money` | 数字文件 |
| 会员到期 | `userss/{admin}/userss/{user}/viptime` | 时间戳 |
| 封禁到期 | `userss/{admin}/userss/{user}/seal` | 时间戳 |
| 注册时间 | `userss/{admin}/userss/{user}/registertime` | 时间戳 |
| 文档数量 | `userss/{admin}/userss/{user}/file_count` | 数字文件 |
| 平台公告 | `userss/{admin}/admin/set/announcement` | 文本文件 |

## 时间戳说明

- **会员到期时间 (viptime)：** Unix 时间戳，表示会员过期的时间。如果大于当前时间，说明会员有效；否则已过期。
- **封禁到期时间 (seal)：** Unix 时间戳，表示封禁解除的时间。如果大于当前时间，说明用户被封禁；否则未被封禁。
- **注册时间 (registertime)：** Unix 时间戳，表示用户注册的时间。

## 常见问题

### Q1: 登录时显示"用户名或密码错误"

**原因：** 输入的账号或密码与数据库中的信息不匹配。

**解决：** 
1. 检查是否执行了 `init_admin.sql` 文件
2. 确认数据库连接信息是否正确
3. 使用默认账号 `admin` 和密码 `123456` 尝试登录

### Q2: 登录时显示"数据库连接失败"

**原因：** 数据库连接信息不正确或数据库服务未启动。

**解决：** 
1. 检查 `admin_config.php` 中的数据库连接信息
2. 确保 MySQL 服务正在运行
3. 确保数据库用户有访问权限

### Q3: 修改密码后无法登录

**原因：** 密码修改成功，需要使用新密码登录。

**解决：** 使用新密码重新登录

### Q4: 用户操作（增加余额、会员等）无效

**原因：** 文件系统权限不足或目录不存在。

**解决：** 
1. 检查目录权限：`chmod 777 userss/{admin}/userss/{user}/`
2. 确保用户目录存在

### Q5: 无法删除用户

**原因：** 目录权限不足。

**解决：** 
```bash
chmod -R 777 userss/{admin}/userss/{user}/
```

## 安全建议

⚠️ **重要安全提示：**

1. **密码加密：** 管理员密码使用 bcrypt 加密存储在数据库中，安全性高。
2. **Session 保护：** 使用 PHP Session 机制保护用户身份，不在 URL 中传递敏感信息。
3. **文件权限：** 确保 `userss/` 目录的权限设置正确，防止未授权访问。
4. **备份数据：** 定期备份数据库和 `userss/` 目录中的用户数据。
5. **HTTPS：** 在生产环境中使用 HTTPS 加密传输。
6. **访问控制：** 限制后台访问 IP，或使用 `.htaccess` 进行访问控制。
7. **定期更新密码：** 定期更新管理员密码。

## 技术支持

如有问题，请检查：
1. PHP 版本是否支持（建议 PHP 5.6+）
2. MySQL 数据库连接是否正常
3. 文件系统权限是否正确
4. 目录结构是否完整
5. 服务器错误日志

## 更新日志

### v2.0 (数据库版本)
- ✅ 管理员账号密码存储在数据库中
- ✅ 使用 bcrypt 加密密码
- ✅ 支持所有用户管理功能
- ✅ 改进了 UI 界面
- ✅ 增加了数据统计功能
- ✅ 支持修改管理员密码

### v1.0 (文件系统版本)
- 基于文件系统的初始版本

---

**最后更新：** 2024年  
**版本：** 2.0（数据库版本）
